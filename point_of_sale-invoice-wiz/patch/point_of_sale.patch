=== modified file 'point_of_sale/point_of_sale.py'
--- point_of_sale/point_of_sale.py	2012-02-13 16:12:01 +0000
+++ point_of_sale/point_of_sale.py	2012-12-27 18:43:36 +0000
@@ -362,7 +362,8 @@
         inv_line_ref = self.pool.get('account.invoice.line')
         product_obj = self.pool.get('product.product')
         inv_ids = []
-
+        group=context.get('group')
+        partners={}
         for order in self.pool.get('pos.order').browse(cr, uid, ids, context=context):
             if order.invoice_id:
                 inv_ids.append(order.invoice_id.id)
@@ -370,7 +371,7 @@
 
             if not order.partner_id:
                 raise osv.except_osv(_('Error'), _('Please provide a partner for the sale.'))
-
+            
             acc = order.partner_id.property_account_receivable.id
             inv = {
                 'name': order.name,
@@ -386,32 +387,97 @@
             inv.update(inv_ref.onchange_partner_id(cr, uid, [], 'out_invoice', order.partner_id.id)['value'])
             if not inv.get('account_id', None):
                 inv['account_id'] = acc
-            inv_id = inv_ref.create(cr, uid, inv, context=context)
+            if group:
+                if (order.partner_id.id,order.sale_journal.id,order.pricelist_id.currency_id.id) in partners:
+                    inv_old=partners.get((order.partner_id.id,order.sale_journal.id,order.pricelist_id.currency_id.id))
+                    self.write(cr, uid, [order.id], {'invoice_id': inv_old, 'state': 'invoiced'}, context=context)
+                    for line in order.lines:
+                        inv_line = {
+                            'invoice_id': inv_old,
+                            'product_id': line.product_id.id,
+                            'quantity': line.qty,
+                        }
+                        inv_name = product_obj.name_get(cr, uid, [line.product_id.id], context=context)[0][1]
+                        inv_line.update(inv_line_ref.product_id_change(cr, uid, [],
+                                                                       line.product_id.id,
+                                                                       line.product_id.uom_id.id,
+                                                                       line.qty, partner_id = order.partner_id.id,
+                                                                       fposition_id=order.partner_id.property_account_position.id)['value'])
+                        if line.product_id.description_sale:
+                            inv_line['note'] = line.product_id.description_sale
+                        inv_line['price_unit'] = line.price_unit
+                        inv_line['discount'] = line.discount
+                        inv_line['name'] = inv_name
+                        inv_line['invoice_line_tax_id'] = ('invoice_line_tax_id' in inv_line)\
+                            and [(6, 0, inv_line['invoice_line_tax_id'])] or []
+                        inv_line_ref.create(cr, uid, inv_line, context=context)
+                    inv_ref.button_reset_taxes(cr, uid, [inv_old], context=context)
+                    wf_service.trg_validate(uid, 'pos.order', order.id, 'invoice', cr)
+                    wf_service.trg_validate(uid, 'account.invoice', inv_old, 'invoice_open', cr)
+                    inv_ref.invoice_report_cbb(cr, uid, [inv_old], context=context)
+                
+                if (order.partner_id.id,order.sale_journal.id,order.pricelist_id.currency_id.id) not in partners :
+                    
+                    inv_id = inv_ref.create(cr, uid, inv, context=context)
+                    partners.update({(order.partner_id.id,order.sale_journal.id,order.pricelist_id.currency_id.id):inv_id})
+                    self.write(cr, uid, [order.id], {'invoice_id': inv_id, 'state': 'invoiced'}, context=context)
+                    inv_ids.append(inv_id)
+                    for line in order.lines:
+                        inv_line = {
+                            'invoice_id': inv_id,
+                            'product_id': line.product_id.id,
+                            'quantity': line.qty,
+                        }
+                        inv_name = product_obj.name_get(cr, uid, [line.product_id.id], context=context)[0][1]
+                        inv_line.update(inv_line_ref.product_id_change(cr, uid, [],
+                                                                       line.product_id.id,
+                                                                       line.product_id.uom_id.id,
+                                                                       line.qty, partner_id = order.partner_id.id,
+                                                                       fposition_id=order.partner_id.property_account_position.id)['value'])
+                        if line.product_id.description_sale:
+                            inv_line['note'] = line.product_id.description_sale
+                        inv_line['price_unit'] = line.price_unit
+                        inv_line['discount'] = line.discount
+                        inv_line['name'] = inv_name
+                        inv_line['invoice_line_tax_id'] = ('invoice_line_tax_id' in inv_line)\
+                            and [(6, 0, inv_line['invoice_line_tax_id'])] or []
+                        inv_line_ref.create(cr, uid, inv_line, context=context)
+                    inv_ref.button_reset_taxes(cr, uid, [inv_id], context=context)
+                    wf_service.trg_validate(uid, 'pos.order', order.id, 'invoice', cr)
+                    wf_service.trg_validate(uid, 'account.invoice', inv_id, 'invoice_open', cr)
+                    inv_ref.invoice_report_cbb(cr, uid, [inv_id], context=context)
+            else:
+                inv.update(inv_ref.onchange_partner_id(cr, uid, [], 'out_invoice', order.partner_id.id)['value'])
+                if not inv.get('account_id', None):
+                    inv['account_id'] = acc
+                inv_id = inv_ref.create(cr, uid, inv, context=context)
 
-            self.write(cr, uid, [order.id], {'invoice_id': inv_id, 'state': 'invoiced'}, context=context)
-            inv_ids.append(inv_id)
-            for line in order.lines:
-                inv_line = {
-                    'invoice_id': inv_id,
-                    'product_id': line.product_id.id,
-                    'quantity': line.qty,
-                }
-                inv_name = product_obj.name_get(cr, uid, [line.product_id.id], context=context)[0][1]
-                inv_line.update(inv_line_ref.product_id_change(cr, uid, [],
-                                                               line.product_id.id,
-                                                               line.product_id.uom_id.id,
-                                                               line.qty, partner_id = order.partner_id.id,
-                                                               fposition_id=order.partner_id.property_account_position.id)['value'])
-                if line.product_id.description_sale:
-                    inv_line['note'] = line.product_id.description_sale
-                inv_line['price_unit'] = line.price_unit
-                inv_line['discount'] = line.discount
-                inv_line['name'] = inv_name
-                inv_line['invoice_line_tax_id'] = ('invoice_line_tax_id' in inv_line)\
-                    and [(6, 0, inv_line['invoice_line_tax_id'])] or []
-                inv_line_ref.create(cr, uid, inv_line, context=context)
-            inv_ref.button_reset_taxes(cr, uid, [inv_id], context=context)
-            wf_service.trg_validate(uid, 'pos.order', order.id, 'invoice', cr)
+                self.write(cr, uid, [order.id], {'invoice_id': inv_id, 'state': 'invoiced'}, context=context)
+                inv_ids.append(inv_id)
+                for line in order.lines:
+                    inv_line = {
+                        'invoice_id': inv_id,
+                        'product_id': line.product_id.id,
+                        'quantity': line.qty,
+                    }
+                    inv_name = product_obj.name_get(cr, uid, [line.product_id.id], context=context)[0][1]
+                    inv_line.update(inv_line_ref.product_id_change(cr, uid, [],
+                                                                   line.product_id.id,
+                                                                   line.product_id.uom_id.id,
+                                                                   line.qty, partner_id = order.partner_id.id,
+                                                                   fposition_id=order.partner_id.property_account_position.id)['value'])
+                    if line.product_id.description_sale:
+                        inv_line['note'] = line.product_id.description_sale
+                    inv_line['price_unit'] = line.price_unit
+                    inv_line['discount'] = line.discount
+                    inv_line['name'] = inv_name
+                    inv_line['invoice_line_tax_id'] = ('invoice_line_tax_id' in inv_line)\
+                        and [(6, 0, inv_line['invoice_line_tax_id'])] or []
+                    inv_line_ref.create(cr, uid, inv_line, context=context)
+                inv_ref.button_reset_taxes(cr, uid, [inv_id], context=context)
+                wf_service.trg_validate(uid, 'pos.order', order.id, 'invoice', cr)
+                wf_service.trg_validate(uid, 'account.invoice', inv_id, 'invoice_open', cr)
+                inv_ref.invoice_report_cbb(cr, uid, [inv_id], context=context)
 
         if not inv_ids: return {}
         

