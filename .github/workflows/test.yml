name: tests

on:
  pull_request:
    branches:
      - "15.0*"
  push:
    branches:
      - "15.0*"

jobs:
  pre-commit-vauxoo:
    runs-on: ubuntu-latest
    name: pre-commit-vauxoo
    steps:
      - uses: actions/checkout@v2
      - name: Cache pre-commit and pip packages
        id: cache-pre-commit-pip
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/pre-commit
            ~/.cache/pip
          key: cache-pre-commit-pip
      - name: Install pre-commit-vauxoo
        run: pip install --upgrade pre-commit-vauxoo
      - name: Run pre-commit-vauxoo
        run: pre-commit-vauxoo
  no-dependency-files:
    runs-on: ubuntu-latest
    name: No dependency files
    steps:
      - uses: actions/checkout@v2
      - name: Ensure dependency files don't exist
        run: |
          for reqfile in requirements.txt oca_dependencies.txt ; do
              if [ -f ${reqfile} ] ; then
                  echo "Please avoid adding requirement files to this repo, because requirements will be installed in all project depending on this one."
                  echo "If you need them for test to work, you can use test-${reqfile} instead of ${reqfile}"
                  exit 1
                fi
           done
  build_deployv:
    runs-on: ubuntu-latest
    name: Build Deployv
    steps:
      - uses: actions/checkout@v2
        with:
          persist-credentials: false
      - name: Cache pip packages
        id: cache-pip-build
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/pre-commit
            ~/.cache/pip
          key: cache-pip-build
      - name: Set ssh keys
        env:
          SSH_AUTH_SOCK: /tmp/ssh_agent.sock
        run: |
          echo ${{ github.sha }}
          echo ${{ github.head_ref }}
          git log --oneline
          echo ${{ github.event.pull_request.head.sha }}
          echo ${{ github.event.pull_request.head.sha || github.sha }}
          ssh-agent -a $SSH_AUTH_SOCK > /dev/null
          ssh-add - <<< "${{ secrets.PRIVATE_DEPLOY_KEY }}"
      - name: Install dependencies
        env:
          SSH_AUTH_SOCK: /tmp/ssh_agent.sock
        run: |
          sudo apt update
          sudo apt install dos2unix
          mkdir -p ~/.ssh/
          ssh-keyscan -H git.vauxoo.com >> ~/.ssh/known_hosts
          pip install -U deployv
      - name: Build image
        env:
          PRIVATE_DEPLOY_KEY: ${{ secrets.PRIVATE_DEPLOY_KEY }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
          DOCKER_USER: ${{ secrets.DOCKER_USER }}
          ORCHEST_REGISTRY: ${{ secrets.ORCHEST_REGISTRY }}
          ORCHEST_TOKEN: ${{ secrets.ORCHEST_TOKEN }}
          SSH_AUTH_SOCK: /tmp/ssh_agent.sock
        run: |
          pip install -U --force-reinstall vxbase vxci
          source variables.sh
          vxci check_keys
          vxci build_image --push_image
      - name: Test odoo image
        env:
          SSH_AUTH_SOCK: /tmp/ssh_agent.sock
        run: |
          source variables.sh
          slugified_branch=$(python -c "from vxci.common import slugify; print(slugify('${GITHUB_HEAD_REF:-${GITHUB_REF_NAME}}'))")
          source ${slugified_branch}/image_name.env
          vxci test_repo --allow_deprecated
